# User and worker processes
user www-data; # Run nginx as www-data user (security)
worker_processes auto; # Number of worker processes = number of CPUs
pid /run/nginx.pid; # PID file location for process management

# Events block - handles connection processing
events {
	worker_connections 1024; # Maximum simultaneous connections per worker
}

# HTTP block - main web server configuration
http {
	# MIME types and basic settings
	include /etc/nginx/mime.types; # Load file extension to content-type mapping
	default_type application/octet-stream; # Default type for unknown extensions

	# Performance optimizations
	sendfile on; # Efficient file transfer (kernel-level)
	tcp_nopush on; # Send headers and file start in same packet
	tcp_nodelay on; # Disable Nagle's algorithm (send data immediately)
	keepalive_timeout 65; # Keep TCP connection alive for 65 seconds
	types_hash_max_size 2048; # Maximum size for MIME types hash table

	# SSL/TLS security settings
	ssl_protocols TLSv1.2 TLSv1.3; # Enable only secure TLS versions
	ssl_prefer_server_ciphers on; # Server chooses encryption cipher

	# Server block - virtual host configuration
	server {
		# Listen on HTTPS port with SSL
		listen 443 ssl; # IPv4
		listen [::]:443 ssl; # IPv6

		server_name eschwart.42.fr; # Domain name

		# SSL certificate paths (generated in Dockerfile)
		ssl_certificate /etc/ssl/certs/nginx.crt;
		ssl_certificate_key /etc/ssl/private/nginx.key;

		# Document root and index files
		root /var/www/html; # WordPress installation directory
		index index.php index.html; # Try index.php first, then index.html

		# Main location - WordPress permalink handling
		location / {
			try_files $uri $uri/ /index.php?$args;
			# Try: 1) exact file, 2) directory, 3) WordPress router
		}

		# PHP-FPM configuration - process PHP files
		location ~ \.php$ {
			# Split script name from path info
			fastcgi_split_path_info ^(.+\.php)(/.+)$;

			# Forward to WordPress container's PHP-FPM on port 9000
			fastcgi_pass wordpress:9000;

			fastcgi_index index.php;
			include fastcgi_params;

			# Pass full script path to PHP-FPM
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;
		}

		# Security - deny access to .htaccess files
		location ~ /\.ht {
			deny all; # Block all requests to .htaccess, .htpasswd, etc.
		}
	}
}

# user www-data;
# worker_processes auto;
# pid /run/nginx.pid;

# events {
# 	worker_connections 1024;
# }

# http {
# 	include       /etc/nginx/mime.types;
# 	default_type  application/octet-stream;

# 	sendfile on;
# 	keepalive_timeout 65;

# 	server {
# 		listen 443 ssl;
# 		server_name nduvoid.42.fr;

# 		ssl_certificate     /etc/nginx/ssl/nduvoid.crt;
# 		ssl_certificate_key /etc/nginx/ssl/nduvoid.key;

# 		root /var/www/html;
# 		index index.php index.html;

# 		location / {
# 			try_files $uri $uri/ /index.php?$args;
# 		}

# 		location ~ \.php$ {
# 			fastcgi_pass wordpress:9000;

# 			fastcgi_index index.php;
# 			include fastcgi_params;

# 			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
# 			fastcgi_param DOCUMENT_ROOT $document_root;
# 			fastcgi_param PATH_INFO $fastcgi_path_info;
# 		}
# 	}
# }

# 	# server {
# 	# 	listen 80;
# 	# 	server_name nduvoid.42.fr;
# 	# 	return 301 https://$host$request_uri;
# 	# }